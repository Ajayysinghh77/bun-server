# Bun Server Framework - v1.1.x Roadmap

> 目标版本：v1.1.0 - v1.1.x\
> 重点：微服务架构支持，优先实现 Nacos 配置中心和服务注册与发现

## 🎯 v1.1.x 版本目标

v1.1.x
版本专注于微服务架构支持，为企业级分布式应用提供完整的微服务基础设施。主要目标包括：

1. **配置中心集成**：优先支持 Nacos 配置中心，实现动态配置管理
2. **服务注册与发现**：基于 Nacos 实现服务注册、发现和负载均衡
3. **微服务通信**：提供 HTTP 客户端和服务间调用支持
4. **服务治理**：实现熔断、限流、重试等微服务治理能力

---

## 🚀 v1.1.0 Roadmap

### Phase 1: Nacos 配置中心集成 🔴 高优先级

**目标**：实现 Nacos 配置中心集成，支持动态配置管理和配置热更新

#### 1.1 Nacos 客户端集成

- [ ] 实现 NacosClient
  - [ ] Nacos 服务器连接管理
  - [ ] 配置获取和监听
  - [ ] 配置变更通知
  - [ ] 连接重试和故障转移
- [ ] 实现配置监听器接口
- [ ] 支持命名空间（Namespace）和分组（Group）
- [ ] 支持配置加密和敏感信息保护

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 1.2 NacosConfigModule

- [ ] 实现 NacosConfigModule
  - [ ] 模块配置（服务器地址、命名空间、分组等）
  - [ ] 配置加载和合并（本地配置 + Nacos 配置）
  - [ ] 配置优先级管理（Nacos > 环境变量 > 默认配置）
  - [ ] 配置热更新支持
- [ ] 集成到 ConfigModule
  - [ ] 扩展 ConfigService 支持 Nacos 配置源
  - [ ] 配置变更自动刷新
  - [ ] 配置监听和回调
- [ ] 提供装饰器支持
  - [ ] `@NacosConfig()` 装饰器
  - [ ] `@NacosValue()` 装饰器（类似 Spring Cloud）
- [ ] 提供示例和文档

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 1.3 配置管理功能

- [ ] 配置监听和热更新
  - [ ] 配置变更监听
  - [ ] 自动刷新应用配置
  - [ ] 配置变更事件通知
- [ ] 配置版本管理
  - [ ] 配置版本追踪
  - [ ] 配置回滚支持
- [ ] 配置加密支持
  - [ ] 敏感配置加密存储
  - [ ] 配置解密和注入

**优先级**：🟡 中\
**预计完成时间**：v1.1.0

---

### Phase 2: 服务注册与发现 🔴 高优先级

**目标**：基于 Nacos 实现服务注册、发现和负载均衡

#### 2.1 Nacos 服务注册

- [ ] 实现 NacosServiceRegistry
  - [ ] 服务实例注册
  - [ ] 服务实例心跳保持
  - [ ] 服务实例下线
  - [ ] 服务实例元数据管理
- [ ] 实现服务注册装饰器
  - [ ] `@ServiceRegistry()` 装饰器
  - [ ] 自动服务注册
  - [ ] 服务元数据配置（版本、权重、健康状态等）
- [ ] 集成到 Application
  - [ ] 应用启动时自动注册
  - [ ] 应用关闭时自动注销
  - [ ] 健康检查集成

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 2.2 Nacos 服务发现

- [ ] 实现 NacosServiceDiscovery
  - [ ] 服务实例查询
  - [ ] 服务实例列表缓存
  - [ ] 服务实例变更监听
  - [ ] 服务实例过滤（版本、标签等）
- [ ] 实现负载均衡
  - [ ] 随机负载均衡（Random）
  - [ ] 轮询负载均衡（RoundRobin）
  - [ ] 加权轮询（WeightedRoundRobin）
  - [ ] 一致性哈希（ConsistentHash）
  - [ ] 最少连接（LeastActive）
- [ ] 实现服务发现装饰器
  - [ ] `@ServiceDiscovery()` 装饰器
  - [ ] 服务实例选择器

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 2.3 ServiceRegistryModule

- [ ] 实现 ServiceRegistryModule
  - [ ] 模块配置（Nacos 服务器地址、命名空间等）
  - [ ] 服务注册配置（服务名、端口、元数据等）
  - [ ] 服务发现配置（服务列表、负载均衡策略等）
- [ ] 集成到 Application
  - [ ] 自动服务注册和发现
  - [ ] 服务健康检查集成
- [ ] 提供示例和文档

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

---

### Phase 3: 微服务通信 🟡 中优先级

**目标**：提供微服务间 HTTP 调用支持

#### 3.1 服务调用客户端

- [ ] 实现 ServiceClient
  - [ ] 基于服务名的服务调用
  - [ ] 自动服务发现和负载均衡
  - [ ] 请求重试机制
  - [ ] 请求超时控制
  - [ ] 请求日志和追踪
- [ ] 实现服务调用装饰器
  - [ ] `@ServiceClient()` 装饰器
  - [ ] `@ServiceCall()` 装饰器
- [ ] 支持多种调用方式
  - [ ] 同步调用
  - [ ] 异步调用
  - [ ] 流式调用

**优先级**：🟡 中\
**预计完成时间**：v1.1.1

#### 3.2 服务调用拦截器

- [ ] 实现请求拦截器
  - [ ] 请求头注入（追踪 ID、用户信息等）
  - [ ] 请求参数转换
  - [ ] 请求日志记录
- [ ] 实现响应拦截器
  - [ ] 响应数据转换
  - [ ] 错误处理
  - [ ] 响应日志记录

**优先级**：🟡 中\
**预计完成时间**：v1.1.1

---

### Phase 4: 服务治理 🟡 中优先级

**目标**：实现熔断、限流、重试等微服务治理能力

#### 4.1 熔断器（Circuit Breaker）

- [ ] 实现熔断器
  - [ ] 熔断状态管理（关闭、开启、半开）
  - [ ] 熔断策略配置（失败率、超时时间等）
  - [ ] 熔断恢复机制
- [ ] 集成到服务调用
  - [ ] 自动熔断保护
  - [ ] 降级处理支持
- [ ] 提供装饰器支持
  - [ ] `@CircuitBreaker()` 装饰器

**优先级**：🟡 中\
**预计完成时间**：v1.1.2

#### 4.2 服务限流

- [ ] 实现服务级限流
  - [ ] 基于服务实例的限流
  - [ ] 分布式限流支持（基于 Redis）
- [ ] 集成到服务调用
  - [ ] 自动限流保护
  - [ ] 限流策略配置

**优先级**：🟡 中\
**预计完成时间**：v1.1.2

#### 4.3 重试机制

- [ ] 实现重试策略
  - [ ] 固定间隔重试
  - [ ] 指数退避重试
  - [ ] 自定义重试策略
- [ ] 集成到服务调用
  - [ ] 自动重试机制
  - [ ] 重试条件配置

**优先级**：🟡 中\
**预计完成时间**：v1.1.2

---

### Phase 5: 监控和追踪 🟢 低优先级

**目标**：提供微服务监控和分布式追踪支持

#### 5.1 分布式追踪

- [ ] 实现分布式追踪
  - [ ] Trace ID 生成和传播
  - [ ] Span 管理
  - [ ] 追踪数据收集
- [ ] 集成到服务调用
  - [ ] 自动追踪支持
  - [ ] 追踪数据上报

**优先级**：🟢 低\
**预计完成时间**：v1.1.3

#### 5.2 服务监控

- [ ] 实现服务监控指标
  - [ ] 服务调用次数
  - [ ] 服务调用延迟
  - [ ] 服务调用错误率
  - [ ] 服务实例健康状态
- [ ] 集成到 MetricsModule
  - [ ] 自动指标收集
  - [ ] Prometheus 格式导出

**优先级**：🟢 低\
**预计完成时间**：v1.1.3

---

## 📦 模块结构规划

```
src/
├── microservice/
│   ├── nacos/
│   │   ├── nacos-client.ts          # Nacos 客户端
│   │   ├── nacos-config-module.ts   # Nacos 配置中心模块
│   │   ├── nacos-service-registry.ts # Nacos 服务注册
│   │   ├── nacos-service-discovery.ts # Nacos 服务发现
│   │   └── types.ts                 # Nacos 相关类型
│   ├── service-client/
│   │   ├── service-client.ts        # 服务调用客户端
│   │   ├── load-balancer.ts         # 负载均衡器
│   │   └── types.ts                 # 服务调用相关类型
│   ├── governance/
│   │   ├── circuit-breaker.ts      # 熔断器
│   │   ├── retry.ts                 # 重试机制
│   │   └── types.ts                 # 治理相关类型
│   ├── tracing/
│   │   ├── tracer.ts                # 分布式追踪
│   │   └── types.ts                 # 追踪相关类型
│   └── index.ts                     # 微服务模块导出
```

---

## 🎯 v1.1.0 发布标准

### 功能完整性

- [ ] Nacos 配置中心集成完成
  - [ ] NacosConfigModule 实现
  - [ ] 配置热更新支持
  - [ ] 配置监听和回调
- [ ] Nacos 服务注册与发现完成
  - [ ] ServiceRegistryModule 实现
  - [ ] 服务注册功能
  - [ ] 服务发现功能
  - [ ] 负载均衡支持

### 稳定性

- [ ] 所有新功能有完整测试覆盖
- [ ] 集成测试通过
- [ ] 性能测试通过
- [ ] 无已知严重 Bug

### 文档

- [ ] 微服务使用指南
- [ ] Nacos 集成文档
- [ ] 服务注册与发现文档
- [ ] 示例代码完整

---

## 📝 实现注意事项

1. **Nacos SDK 选择**：
   - 优先使用官方 Nacos Node.js SDK
   - 如果官方 SDK 不完善，考虑自行实现或使用社区 SDK

2. **配置优先级**：
   - Nacos 配置 > 环境变量 > 默认配置
   - 支持配置合并和覆盖

3. **服务注册**：
   - 应用启动时自动注册
   - 定期发送心跳保持连接
   - 应用关闭时自动注销

4. **服务发现**：
   - 支持服务实例列表缓存
   - 监听服务实例变更
   - 支持多种负载均衡策略

5. **向后兼容**：
   - 新功能不影响现有功能
   - 微服务功能为可选模块，不影响单机部署

6. **性能考虑**：
   - 配置和服务列表缓存
   - 异步更新机制
   - 连接池管理

---

## 🔗 相关资源

- [v1.0.0 Roadmap](./v1.0.0.md)
- [v1.x.x 汇总清单](./v1.x.x.md)
- [Nacos 官方文档](https://nacos.io/docs/latest/)
- [微服务最佳实践](../docs/best-practices.md)
