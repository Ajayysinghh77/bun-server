---
description: Bun Server Framework 测试规范和最佳实践
globs: "*.test.ts"
alwaysApply: true
---

# 测试规范

本文档定义了 Bun Server Framework 项目的测试规范和最佳实践。

## 测试框架

- 使用 `bun:test`（Bun 内置测试框架）
- 使用 `describe` 和 `test` 组织测试
- 测试文件命名：`*.test.ts`

```typescript
import { describe, expect, test, beforeEach } from 'bun:test';

describe('MyService', () => {
  let service: MyService;

  beforeEach(() => {
    service = new MyService();
  });

  test('should do something', () => {
    expect(service.method()).toBe(expected);
  });
});
```

## 测试文件组织

测试文件按模块组织，与源码结构对应：

```
tests/
├── config/
│   └── config-module.test.ts
├── health/
│   └── health-module.test.ts
├── security/
│   ├── jwt-provider.test.ts
│   ├── authentication-manager.test.ts
│   └── ...
└── swagger/
    ├── generator.test.ts
    └── ...
```

## 测试覆盖要求

### 新模块必须包含的测试

1. **模块配置测试**
   - `forRoot()` 方法正确注册 providers
   - 配置选项正确应用
   - 模块导出正确

2. **服务功能测试**
   - 核心功能测试
   - 边界情况测试
   - 错误处理测试

3. **集成测试**
   - 与其他模块的集成
   - DI 容器解析
   - 模块导入导出

### 测试示例

```typescript
import { describe, expect, test, beforeEach } from 'bun:test';
import { ConfigModule, ConfigService, CONFIG_SERVICE_TOKEN } from '../../src/config';
import { Container } from '../../src/di/container';
import { ModuleRegistry } from '../../src/di/module-registry';
import { MODULE_METADATA_KEY } from '../../src/di/module';
import 'reflect-metadata';

describe('ConfigModule', () => {
  beforeEach(() => {
    // 清除模块元数据
    Reflect.deleteMetadata(MODULE_METADATA_KEY, ConfigModule);
  });

  test('should register config service provider', () => {
    ConfigModule.forRoot({
      defaultConfig: { app: { name: 'Test' } },
    });

    const metadata = Reflect.getMetadata(MODULE_METADATA_KEY, ConfigModule);
    expect(metadata.providers).toBeDefined();
    // ...
  });
});
```

## 测试最佳实践

### 1. 使用 beforeEach/afterEach

```typescript
describe('MyService', () => {
  let service: MyService;
  let container: Container;

  beforeEach(() => {
    container = new Container();
    service = new MyService();
  });

  afterEach(() => {
    container.clear();
  });
});
```

### 2. 测试隔离

- 每个测试应该是独立的
- 使用 `beforeEach` 重置状态
- 避免测试之间的依赖

### 3. 描述性测试名称

```typescript
// ✅ 正确
test('should return null when user not found', () => {});
test('should throw error when validation fails', () => {});

// ❌ 错误
test('test1', () => {});
test('works', () => {});
```

### 4. 测试异步代码

```typescript
test('should handle async operation', async () => {
  const result = await service.asyncMethod();
  expect(result).toBeDefined();
});
```

### 5. 测试错误情况

```typescript
test('should throw error for invalid input', () => {
  expect(() => service.method('invalid')).toThrow();
  expect(() => service.method('invalid')).toThrow('Invalid input');
});
```

## 模块测试模式

### ConfigModule 测试模式

```typescript
describe('ConfigModule', () => {
  test('should register config service', () => {
    ConfigModule.forRoot({ defaultConfig: {} });
    // 检查 metadata
  });

  test('should merge defaultConfig and env-loaded config', () => {
    // 测试配置合并
  });

  test('should validate config', () => {
    // 测试配置验证
  });
});

describe('ConfigService', () => {
  test('should get and set values via path', () => {
    // 测试路径访问
  });

  test('should support namespace', () => {
    // 测试命名空间
  });
});
```

### HealthModule 测试模式

```typescript
describe('HealthModule', () => {
  test('should register controller and providers', () => {
    HealthModule.forRoot({ indicators: [] });
    // 检查 metadata
  });
});

describe('HealthController', () => {
  test('should return up status when all indicators are up', async () => {
    // 测试健康检查逻辑
  });

  test('should return down status when any indicator is down', async () => {
    // 测试失败情况
  });
});
```

## 运行测试

```bash
# 运行所有测试
bun test

# 运行特定模块测试
bun test tests/config
bun test tests/health

# 运行特定测试文件
bun test tests/config/config-module.test.ts
```

## 测试覆盖率目标

- 新模块：100% 核心功能覆盖
- 现有模块：逐步提升至 85%+
- 关键路径：必须 100% 覆盖

## 注意事项

1. **模块元数据清理**：测试前清除 `Reflect` 元数据，避免测试间污染
2. **Container 清理**：使用 `container.clear()` 清理容器状态
3. **测试端口**：使用 `getTestPort()` 工具函数避免端口冲突
4. **异步测试**：确保正确处理异步操作和 Promise
